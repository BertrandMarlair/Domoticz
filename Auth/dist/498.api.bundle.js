exports.id=498,exports.ids=[498],exports.modules={18967:e=>{function r(e){var r=new Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}r.keys=()=>[],r.resolve=r,r.id=18967,e.exports=r},59388:e=>{function r(e){var r=new Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}r.keys=()=>[],r.resolve=r,r.id=59388,e.exports=r},68511:e=>{function r(e){var r=new Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}r.keys=()=>[],r.resolve=r,r.id=68511,e.exports=r},38846:(e,r,t)=>{"use strict";t.r(r);var n=t(99268),i=t.n(n),a=t(98605),s=t.n(a),o=t(10046),c=t.n(o),l=t(63395),p=t.n(l),d=t(32589),u=t.n(d),m=t(17846),y=t.n(m),w=t(97280),_=t.n(w),f=t(85622),h=t.n(f),g=t(38137),T=t(34156),E=t.n(T);class b{constructor(){this.store=new Map,this.mems=new Map}memoize(e,...r){this.mems.has(e)||this.mems.set(e,E()(e,{normalizer:e=>JSON.stringify(e)}));const t=this.mems.get(e),n=JSON.stringify(r);return this.store.set(t,this.store.has(t)?[...this.store.get(t),n]:[n]),t(...r)}clear(){Array.from(this.store.entries()).forEach((([e,r])=>r.forEach((r=>e.delete(...JSON.parse(r))))))}}var v=t(49704),O=t(89135),k=t(25144);const A=async e=>{const{PRIVATE_KEY:r,PUBLIC_KEY:t,SECRET_REGISTER:n}=process.env,i={_id:e._id,name:e.name,type:e.type,permissions:e.permissions},a={expiresIn:k.C7,algorithm:"RS256"},s={expiresIn:k.Wt,algorithm:"RS256"},o=await(0,v.sign)(i,{key:r,passphrase:n},a),c=await(0,v.sign)({_id:e._id},{key:r,passphrase:n},s);return(0,v.verify)(o,t,{algorithms:["RS256"]}),{accessToken:o,refreshToken:c}},S=async({token:e})=>{if(!e)throw new O.AuthenticationError("You must supply a JWT for authorization.");const{PUBLIC_KEY:r}=process.env;try{return(0,v.verify)(e,r,{algorithm:["RS256"]})}catch(e){throw console.log("err",e),new O.AuthenticationError("Invalid JWT")}};var U=t(96047);const N=(0,U.scalarType)({name:"Email",asNexusMethod:"email",description:"Email custom scalar type",Email:(...e)=>GraphQLEmail(...e)});var D=t(68303);const R=(0,U.scalarType)({name:"Json",asNexusMethod:"json",description:"Json custom scalar type",JSON:D.ZP,JSONObject:D.C1}),I={scalar:[N,(0,U.scalarType)({name:"Timestamp",asNexusMethod:"timestamp",description:"Unix Milliseconds Timestamp",serialize(e){if(isNaN(e))throw new Error("Timestamp isn't a valid timestamp value");return new Date(e).getTime()},parseValue(e){if(isNaN(parseFloat(e)))throw new Error("Timestamp isn't a valid timestamp value");return new Date(parseFloat(e)).getTime()},parseLiteral({value:e}){return new Date(this.parseValue(e)).getTime()}}),R],input:[(0,U.objectType)({name:"Delete",definition(e){e.int("id")}}),(0,U.objectType)({name:"Status",definition(e){e.string("title"),e.field("code",{type:"String",resolve:({statusCode:e})=>e}),e.string("color")}})]},M=(0,U.enumType)({name:"LogicalOperator",members:["and","or"],description:"LogicalOperator for filterate"}),P=(0,U.inputObjectType)({name:"Filter",definition(e){e.string("operator"),e.list.string("values"),e.field("inner_stack_operator",{type:M})}}),x=(0,U.inputObjectType)({name:"FilterOperation",definition(e){e.field("inner_stack_operator",{type:M}),e.string("key",{nullable:!1}),e.list.field("filters",{type:P,nullable:!1})}}),j=(0,U.objectType)({name:"AvailableFilter",definition(e){e.string("label",{nullable:!1}),e.string("key",{nullable:!1}),e.string("type",{nullable:!1}),e.string("formType",{nullable:!1}),e.list.string("valid_operators",{nullable:!1})}}),q=(0,U.enumType)({name:"Order",members:["DESC","ASC"],description:"Order for filterate"}),C=(0,U.inputObjectType)({name:"PaginationParams",definition(e){e.int("page"),e.int("pageSize"),e.string("orderKey"),e.field("orderValue",{type:q})}}),L=(0,U.inputObjectType)({name:"Pagination",definition(e){e.list.field("filtrate",{type:x,nullable:!1}),e.field("pagination",{type:C})}}),$={enum:[M,q],input:[P,x,L,C],type:[j]},F=(0,U.enumType)({name:"TypeEnum",members:["user","device"],description:"Type for user"}),H=(0,U.inputObjectType)({name:"registerInput",definition(e){e.string("name",{required:!0}),e.string("type",{required:!0,type:F}),e.string("password",{required:!0}),e.string("passwordConfirmation",{required:!0})}}),B=(0,U.enumType)({name:"PermissionEnum",members:["guest","member","admin"],description:"Permission for user"}),G=(0,U.objectType)({name:"UserAuth",definition(e){e.field("_id",{type:"ID"}),e.string("name",{nullable:!1}),e.string("type",{nullable:!1,type:F}),e.string("permission",{nullable:!1,type:B}),e.timestamp("updatedAt"),e.timestamp("createdAt")}});var J=t(10858),z=t.n(J),K=t(20501);const Y={reconnectTries:30,reconnectInterval:500,poolSize:10,bufferMaxEntries:0,useNewUrlParser:!0,useUnifiedTopology:!0},{MONGO_AUTH_HOSTNAME:V,MONGO_AUTH_NAME:W,MONGO_AUTH_PORT:Q,MONGO_INITDB_ROOT_USERNAME:X,MONGO_INITDB_ROOT_PASSWORD:Z}=process.env,ee=async()=>{try{const e=K.MongoClient.connect(`mongodb://${X}:${Z}@${V}:${Q}`,Y);return await e.then((e=>e.db(W))).catch((e=>{console.log(e)}))||{error:"Impossible to connect to the database"}}catch(e){return{error:e.message}}},re=async(e,r)=>{const t=await ee();return await t.collection(e).findOne(r)},te=async(e,r,t)=>await(async(e,r,t)=>{const n=await ee();return(await n.collection(e).findOneAndUpdate(r,t,{returnOriginal:!1})).value})(e,{_id:new K.ObjectId(r)},t),ne=async e=>await(async(e,r)=>await re("users",{_id:new K.ObjectId(r)}))(0,e),ie=async e=>await re("users",{name:e}),ae=async(e,r)=>await te("users",e,r),se=(0,U.objectType)({name:"Login",definition(e){e.field("identity",{type:G,nullable:!0}),e.string("accessToken",{nullable:!0}),e.string("refreshToken",{nullable:!0})}}),oe=(0,U.inputObjectType)({name:"editUserInput",definition(e){e.string("name",{required:!0}),e.string("type",{required:!0,type:F})}}),ce=async()=>await(async(e,r)=>{const t=await ee();return await t.collection(e).find(r).toArray()})("users",{}),le={type:[G,se],mutation:[e=>e.field("signin",{type:G,args:{user:H},resolve:async(...e)=>await(async(e,{user:r})=>{try{if(await ie(r.name))throw new g.AuthenticationError("connect.signin.errors.alreadyRegistered");if(r?.password!==r?.passwordConfirmation)throw new g.AuthenticationError("auth.identity.invalidPasswordConfirmation");if(r?.password.length<8)throw new g.AuthenticationError("error.validation.passwordIsTooSmall");const e=await z().hash(r.password,k.i7),t=await(async(e,r)=>{const t=await ee();return(await t.collection("users").insertOne(r)).ops[0]})(0,{name:r.name,type:r.type,active:!0,permission:"guest",basic:{verified:!1,password:e,createdAt:new Date},createdAt:new Date,updatedAt:new Date});if(t&&t._id)return t;throw new Error("connect.register.failedToCreateOnPortal")}catch(e){throw new g.ForbiddenError(e)}})(...e)}),e=>e.field("login",{type:se,args:{name:(0,U.stringArg)({required:!0}),password:(0,U.stringArg)({required:!0})},resolve:async(...e)=>await(async(e,{name:r,password:t})=>{try{const e=await ie(r);if(!e)throw new Error("connect.login.errors.failLogin");if(!e.basic.verified)throw new Error("connect.login.errors.unverified");if(!e.active)throw new Error("connect.login.errors.locked");if(e?.basic?.signTry?.[k.Ih]&&new Date(e?.basic?.signTry[0]).getTime()>(new Date).getTime()-k.no)throw await ae(e._id,{$pull:{"basic.signTry":{$lt:new Date((new Date).getTime()-k.no)}}}),new Error("connect.login.errors.tooManyTry");if(!await z().compare(t,e.basic.password))throw await ae(e._id,{$push:{"basic.signTry":new Date}}),new Error("connect.login.errors.failLogin");const n=await ae(e._id,{$set:{"basic.lastLogin":new Date,"basic.signTry":[],updatedAt:new Date}}),{accessToken:i,refreshToken:a}=await A(e);if(n?._id)return{accessToken:i,refreshToken:a,identity:{...n}};throw new Error("connect.login.errors.failLogin")}catch(e){throw new g.ForbiddenError(e)}})(...e)}),e=>e.field("updateUser",{type:G,args:{name:(0,U.stringArg)({required:!0}),type:(0,U.arg)({type:F,required:!0})},resolve:async(...e)=>await(async(e,{name:r,type:t},{currentUser:n})=>{try{const e=await ne(n._id);if(!e?._id)throw new g.AuthenticationError("connect.updateUser.errors.notFound");const i=await te("users",e._id,{$set:{name:r,type:t}});if(i&&i._id)return i;throw new Error("connect.updateUser.updateUser")}catch(e){throw new g.ForbiddenError(e)}})(...e)})],query:[e=>e.field("getCurrentUser",{type:G,nullable:!1,async resolve(e,r,{currentUser:t}){const n=await ne(t._id);if(!n)throw new g.AuthenticationError("fail to found user");return n}}),e=>e.field("checkAuthUser",{type:G,nullable:!1,async resolve(e,r,{token:t,currentUser:n}){if(!t)throw new g.AuthenticationError("jwt not exist");if(!await S({token:t.replace("Bearer ","")}))throw new g.AuthenticationError("invalid jwt");const i=await ne(n._id);if(console.log("authUser",i),!i)throw new g.AuthenticationError("fail to found user");if(!i.basic.verified)throw new Error("connect.login.errors.unverified");if(!i.active)throw new Error("connect.login.errors.locked");return i}}),e=>e.list.field("getAllUsers",{type:G,nullable:!0,resolve:async(...e)=>await ce(...e)})],input:[H,oe],enum:[F]},pe=(0,U.objectType)({name:"KeyRing",definition(e){e.string("accessPublicKey",{nullable:!1})}}),de=(0,U.objectType)({name:"TokensType",definition(e){e.string("accessToken",{nullable:!1}),e.string("refreshToken",{nullable:!1})}}),ue=[I,$,le,{type:[pe,de],query:[e=>e.field("keyRing",{type:pe,args:{token:(0,U.stringArg)({required:!0})},nullable:!1,async resolve(e,{token:r}){const{SECRET_REGISTER:t,PUBLIC_KEY:n}=process.env;if(r===t)return{accessPublicKey:n};throw new Error("Invalid secret")}}),e=>e.field("refreshTokens",{type:de,nullable:!1,async resolve(e,r,{refreshToken:t}){if(!t)throw new Error("missing refresh-token");const{_id:n}=(0,v.decode)(t.replace("Bearer ","")),i=await ne(n);if(!i)throw new Error("fail to get user data");const{accessToken:a,refreshToken:s}=await A(i);return{accessToken:a,refreshToken:s}}})]}],{GRAPHQL_QUERY_MAX_DEPTH:me}=process.env,ye=(e,{context:r})=>(r.memoizer.clear(),e),we=e=>(console.log("_________________________________"),console.log(e),console.log("_________________________________"),e),_e=(0,U.makeSchema)({types:[(fe=ue,(0,U.queryType)({definition(e){fe.forEach((r=>{r.query&&r.query.forEach((r=>{r(e)}))}))}})),(e=>e.map((e=>e.type)))(ue),(e=>(0,U.mutationType)({definition(r){e.forEach((e=>{e.mutation&&e.mutation.forEach((e=>{e(r)}))}))}}))(ue),(e=>e.map((e=>e.subscription)))(ue),(e=>e.map((e=>e.scalar)))(ue),(e=>e.map((e=>e.input)))(ue),(e=>e.map((e=>e.enum)))(ue),(e=>e.map((e=>e.union)))(ue)],outputs:{schema:h().join(__dirname.replace(/\/dist$/,"/bin"),"../../bin/portal_api_schema.graphql"),typegen:h().join(__dirname.replace(/\/dist$/,"/bin"),"../../bin/portal_api_schema_typegen.ts")}});var fe;var he=t(54005),ge=t.n(he);const{REDIS_HOST:Te,REDIS_PORT:Ee}=process.env;var be=t(95692);const ve=p()(),Oe=i()(),ke=s().createServer(Oe),{AUTH_HOST:Ae,AUTH_PORT:Se,NODE_ENV:Ue}=process.env;Oe.use(y()({origin:"*",credentials:!0})),Oe.use(c().text({type:"application/graphql"})),ve.start("Starting server..."),[{path:"/health",controller:async(e,r)=>{try{return r.status(200).send("Health check success")}catch(e){return r.status(400).send(e.message)}},type:"post"}].forEach((e=>{Oe.post(e.path,((r,t)=>{e.controller(r,t)}))}));const Ne=async()=>{try{const e=((e,r=!0)=>new g.ApolloServer({schema:_e,validationRules:[_()(me)],playground:r,introspection:!0,tracing:!0,formatError:we,formatResponse:ye,context:e=>(async e=>{let r,t;const n=e.req&&e.req.headers,i=e.connection&&e.connection.context;if(n){const e=n["access-token"];e&&"null"!==e&&"undefined"!==e&&(r=e.replace("Bearer ",""),t=await S({token:r}))}if(i&&i&&i.headers.context){const e=i.headers.context,n=e.token||e["access-token"];n&&(r=n.replace("Bearer ",""),t=await S({token:r}))}return{headers:n,memoizer:new b,token:r,identityEmail:t&&t.identity_email,currentUser:t,refreshToken:n["refresh-token"]}})(e),subscriptions:{onConnect:async e=>{if(e&&e.headers.context){const r=e.headers.context;if(r.token||r["access-token"])return e}throw new Error("Missing auth token!")}}}))();e.installSubscriptionHandlers(ke),e.applyMiddleware({app:Oe,path:"/"}),new(ge())(Ee,Te).publish("updateServer","Restart Portal API"),ke.listen(Se,(()=>{ve.succeed(),console.log(u().green("âœ“"),`Server ready. -> start on ${Ae}:${Se}/`)}))}catch(e){ve.fail(),await(0,be.Dc)(5e3),console.log("ðŸ’£",e.message),console.log("ðŸ’£","reconnecting in 5 seconds"),Ne()}};Ne(),ke.on("error",(e=>{ve.fail(),console.log(e),console.log("ðŸ’£",u().red("error:"),e.message)}))}};