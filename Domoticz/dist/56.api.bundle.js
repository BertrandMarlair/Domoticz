exports.id=56,exports.ids=[56],exports.modules={18967:e=>{function t(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=18967,e.exports=t},46700:(e,t,i)=>{var r={"./af":42786,"./af.js":42786,"./ar":30867,"./ar-dz":14130,"./ar-dz.js":14130,"./ar-kw":96135,"./ar-kw.js":96135,"./ar-ly":56440,"./ar-ly.js":56440,"./ar-ma":47702,"./ar-ma.js":47702,"./ar-sa":16040,"./ar-sa.js":16040,"./ar-tn":37100,"./ar-tn.js":37100,"./ar.js":30867,"./az":31083,"./az.js":31083,"./be":9808,"./be.js":9808,"./bg":68338,"./bg.js":68338,"./bm":67438,"./bm.js":67438,"./bn":8905,"./bn.js":8905,"./bo":11560,"./bo.js":11560,"./br":1278,"./br.js":1278,"./bs":80622,"./bs.js":80622,"./ca":2468,"./ca.js":2468,"./cs":5822,"./cs.js":5822,"./cv":50877,"./cv.js":50877,"./cy":47373,"./cy.js":47373,"./da":24780,"./da.js":24780,"./de":59740,"./de-at":60217,"./de-at.js":60217,"./de-ch":60894,"./de-ch.js":60894,"./de.js":59740,"./dv":5300,"./dv.js":5300,"./el":50837,"./el.js":50837,"./en-SG":85383,"./en-SG.js":85383,"./en-au":78348,"./en-au.js":78348,"./en-ca":77925,"./en-ca.js":77925,"./en-gb":22243,"./en-gb.js":22243,"./en-ie":46436,"./en-ie.js":46436,"./en-il":47207,"./en-il.js":47207,"./en-nz":76319,"./en-nz.js":76319,"./eo":92915,"./eo.js":92915,"./es":55655,"./es-do":55251,"./es-do.js":55251,"./es-us":71146,"./es-us.js":71146,"./es.js":55655,"./et":5603,"./et.js":5603,"./eu":77763,"./eu.js":77763,"./fa":76959,"./fa.js":76959,"./fi":11897,"./fi.js":11897,"./fo":94694,"./fo.js":94694,"./fr":94470,"./fr-ca":63049,"./fr-ca.js":63049,"./fr-ch":52330,"./fr-ch.js":52330,"./fr.js":94470,"./fy":5044,"./fy.js":5044,"./ga":29295,"./ga.js":29295,"./gd":2101,"./gd.js":2101,"./gl":38794,"./gl.js":38794,"./gom-latn":23168,"./gom-latn.js":23168,"./gu":95349,"./gu.js":95349,"./he":24206,"./he.js":24206,"./hi":30094,"./hi.js":30094,"./hr":30316,"./hr.js":30316,"./hu":22138,"./hu.js":22138,"./hy-am":11423,"./hy-am.js":11423,"./id":29218,"./id.js":29218,"./is":90135,"./is.js":90135,"./it":90626,"./it-ch":10150,"./it-ch.js":10150,"./it.js":90626,"./ja":39183,"./ja.js":39183,"./jv":24286,"./jv.js":24286,"./ka":12105,"./ka.js":12105,"./kk":47772,"./kk.js":47772,"./km":18758,"./km.js":18758,"./kn":79282,"./kn.js":79282,"./ko":33730,"./ko.js":33730,"./ku":1408,"./ku.js":1408,"./ky":33291,"./ky.js":33291,"./lb":36841,"./lb.js":36841,"./lo":55466,"./lo.js":55466,"./lt":57010,"./lt.js":57010,"./lv":37595,"./lv.js":37595,"./me":39861,"./me.js":39861,"./mi":35493,"./mi.js":35493,"./mk":95966,"./mk.js":95966,"./ml":87341,"./ml.js":87341,"./mn":5115,"./mn.js":5115,"./mr":10370,"./mr.js":10370,"./ms":9847,"./ms-my":41237,"./ms-my.js":41237,"./ms.js":9847,"./mt":72126,"./mt.js":72126,"./my":56165,"./my.js":56165,"./nb":64924,"./nb.js":64924,"./ne":16744,"./ne.js":16744,"./nl":93901,"./nl-be":59814,"./nl-be.js":59814,"./nl.js":93901,"./nn":83877,"./nn.js":83877,"./pa-in":15858,"./pa-in.js":15858,"./pl":64495,"./pl.js":64495,"./pt":89520,"./pt-br":57971,"./pt-br.js":57971,"./pt.js":89520,"./ro":96459,"./ro.js":96459,"./ru":21793,"./ru.js":21793,"./sd":40950,"./sd.js":40950,"./se":10490,"./se.js":10490,"./si":90124,"./si.js":90124,"./sk":64249,"./sk.js":64249,"./sl":14985,"./sl.js":14985,"./sq":51104,"./sq.js":51104,"./sr":49131,"./sr-cyrl":79915,"./sr-cyrl.js":79915,"./sr.js":49131,"./ss":85893,"./ss.js":85893,"./sv":98760,"./sv.js":98760,"./sw":91172,"./sw.js":91172,"./ta":27333,"./ta.js":27333,"./te":23110,"./te.js":23110,"./tet":52095,"./tet.js":52095,"./tg":27321,"./tg.js":27321,"./th":9041,"./th.js":9041,"./tl-ph":75768,"./tl-ph.js":75768,"./tlh":89444,"./tlh.js":89444,"./tr":72397,"./tr.js":72397,"./tzl":28254,"./tzl.js":28254,"./tzm":51106,"./tzm-latn":30699,"./tzm-latn.js":30699,"./tzm.js":51106,"./ug-cn":9288,"./ug-cn.js":9288,"./uk":67691,"./uk.js":67691,"./ur":13795,"./ur.js":13795,"./uz":6791,"./uz-latn":60588,"./uz-latn.js":60588,"./uz.js":6791,"./vi":65666,"./vi.js":65666,"./x-pseudo":14378,"./x-pseudo.js":14378,"./yo":75805,"./yo.js":75805,"./zh-cn":83839,"./zh-cn.js":83839,"./zh-hk":55726,"./zh-hk.js":55726,"./zh-tw":74152,"./zh-tw.js":74152};function s(e){var t=n(e);return i(t)}function n(e){if(!i.o(r,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return r[e]}s.keys=function(){return Object.keys(r)},s.resolve=n,e.exports=s,s.id=46700},59388:e=>{function t(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=59388,e.exports=t},68511:e=>{function t(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=68511,e.exports=t},27400:(e,t,i)=>{"use strict";i.r(t);var r=i(99268),s=i.n(r),n=i(98605),a=i.n(n),o=i(10046),l=i.n(o),c=i(63395),d=i.n(c),p=i(32589),u=i.n(p),y=i(17846),g=i.n(y);var h=i(97280),m=i.n(h),w=i(85622),f=i.n(w),b=i(38137),_=i(34156),j=i.n(_);class v{constructor(){this.store=new Map,this.mems=new Map}memoize(e,...t){this.mems.has(e)||this.mems.set(e,j()(e,{normalizer:e=>JSON.stringify(e)}));const i=this.mems.get(e),r=JSON.stringify(t);return this.store.set(i,this.store.has(i)?[...this.store.get(i),r]:[r]),i(...t)}clear(){Array.from(this.store.entries()).forEach((([e,t])=>t.forEach((t=>e.delete(...JSON.parse(t))))))}}var I=i(49704),E=i(89135),k=i(28687);const T=async e=>{if(!e)throw new E.AuthenticationError("You must supply a JWT for authorization.");const t=await(async()=>{const{SECRET_REGISTER:e}=process.env,t=`\n        query keyRing {\n            keyRing (token: "${e}") {\n                accessPublicKey\n            }\n        }\n    `,{AUTH_HOST:i,AUTH_PORT:r}=process.env,s=await(0,k.request)(`http://${i}:${r}/graphql`,t).then((e=>e)).catch((e=>e));if(s.keyRing&&s.keyRing.accessPublicKey)return s.keyRing.accessPublicKey;throw new Error("Failed to get access token")})();try{return(0,I.verify)(e.replace("Bearer ",""),t,{algorithm:["RS256"]})}catch(e){throw console.log(e),new E.AuthenticationError("Invalid JWT")}};var $=i(96047);const O=(0,$.scalarType)({name:"Email",asNexusMethod:"email",description:"Email custom scalar type",Email:(...e)=>GraphQLEmail(...e)});var S=i(68303);const A=(0,$.scalarType)({name:"Json",asNexusMethod:"json",description:"Json custom scalar type",JSON:S.ZP,JSONObject:S.C1}),q={scalar:[O,(0,$.scalarType)({name:"Timestamp",asNexusMethod:"timestamp",description:"Unix Milliseconds Timestamp",serialize(e){if(isNaN(e))throw new Error("Timestamp isn't a valid timestamp value");return new Date(e).getTime()},parseValue(e){if(isNaN(parseFloat(e)))throw new Error("Timestamp isn't a valid timestamp value");return new Date(parseFloat(e)).getTime()},parseLiteral({value:e}){return new Date(this.parseValue(e)).getTime()}}),A],input:[(0,$.objectType)({name:"Delete",definition(e){e.int("id")}}),(0,$.objectType)({name:"Status",definition(e){e.string("title"),e.field("code",{type:"String",resolve:({statusCode:e})=>e}),e.string("color")}})]},P=(0,$.objectType)({name:"Application",definition(e){e.field("_id",{type:"ID"}),e.string("title"),e.string("description")}}),H={type:[P],query:[e=>e.list.field("getAllApplications",{type:P,nullable:!0,resolve:async(...e)=>await(async()=>[{_id:"891374917391",title:"Domotics",description:"this is a try"},{_id:"891374917392",title:"Jeedmon",description:"this is a try"}])(...e)})],mutation:[e=>e.field("editApplication",{type:P,resolve:async(...e)=>await(async()=>({}))(...e)})]},x=(0,$.objectType)({name:"Provider",definition(e){e.field("_id",{type:"ID"}),e.string("title"),e.string("slug"),e.string("icon"),e.string("button"),e.string("description")}});var D=i(25144),N=i(20501);const R={reconnectTries:30,reconnectInterval:500,poolSize:10,bufferMaxEntries:0,useNewUrlParser:!0,useUnifiedTopology:!0},{MONGO_DOMOTICZ_HOSTNAME:B,MONGO_DOMOTICZ_NAME:z,MONGO_DOMOTICZ_PORT:C}=process.env,M=j()((async()=>{try{const e=N.MongoClient.connect(`mongodb://${B}:${C}`,R);return await e.then((e=>e.db(z))).catch((e=>{console.log(e)}))||{error:"Impossible to connect to the database"}}catch(e){return{error:e.message}}})),U=async(e,t)=>{const i=await M();return await i.collection(e).find(t).toArray()},L=async(e,t)=>{const i=await M();return await i.collection(e).findOne(t)},F=async(e,t)=>await L(e,{_id:new N.ObjectId(t)}),G=async(e,t,i)=>{const r=await M();return(await r.collection(e).updateMany({_id:new N.ObjectId(t)},i,{returnOriginal:!1})).value},Y=async(e,t,i)=>await(async(e,t,i)=>{const r=await M();return(await r.collection(e).findOneAndUpdate(t,i,{returnOriginal:!1})).value})(e,{_id:new N.ObjectId(t)},i),J=async(e,t)=>{const i=await M();return(await i.collection(e).insertOne(t)).ops[0]},W=async(e,t)=>{const i=await M();return await i.collection(e).deleteOne({_id:new N.ObjectId(t)})},Z=(0,$.inputObjectType)({name:"editProviderInput",definition(e){e.id("_id",{required:!0}),e.string("title",{required:!0}),e.string("description",{required:!0}),e.string("slug",{required:!0}),e.string("icon",{required:!0}),e.string("button",{required:!0})}}),K=(0,$.inputObjectType)({name:"createProviderInput",definition(e){e.string("title",{required:!0}),e.string("description",{required:!0}),e.string("slug",{required:!0}),e.string("icon",{required:!0}),e.string("button",{required:!0})}}),Q="Providers",V={type:[x],query:[e=>e.list.field("getAllProviders",{type:x,nullable:!0,resolve:async(...e)=>await(async()=>await U(Q,{}))(...e)})],mutation:[e=>e.field("createProvider",{type:x,args:{provider:(0,$.arg)({type:K,required:!0})},resolve:async(...e)=>await(async(e,{provider:t})=>{if(await L(Q,{slug:t.slug}))throw new Error("provider.edit.errors.alreadyExist");const i=await J(Q,{...t});return console.log(i),i})(...e)}),e=>e.field("editProvider",{type:x,args:{provider:(0,$.arg)({type:Z,required:!0})},resolve:async(...e)=>await(async(e,{provider:t})=>{if(!await F(Q,t._id))throw new Error("provider.edit.errors.notFound");const i=await Y(Q,t._id,{$set:{title:t.title,description:t.description,slug:t.slug,icon:t.icon,button:t.button}});return console.log(i),i})(...e)}),e=>e.field("deleteProvider",{type:x,args:{_id:(0,$.idArg)({required:!0})},resolve:async(...e)=>await(async(e,{_id:t})=>{const i=await F(Q,t);if(!i)throw new Error("provider.edit.errors.notFound");return await W(Q,t),console.log(i),i})(...e)})],input:[Z,K]},X=(0,$.objectType)({name:"Test",definition(e){e.field("_id",{type:"ID"}),e.string("title"),e.string("description")}}),ee={type:[X],query:[e=>e.list.field("getAllTests",{type:X,nullable:!0,resolve:async(...e)=>await(async()=>[{_id:"891374917391",title:"Domotics",description:"this is a test"},{_id:"891374917392",title:"Jeedmon",description:"this is a test"}])(...e)})],mutation:[e=>e.field("editTest",{type:X,resolve:async(...e)=>await(async()=>({}))(...e)})]},te=(0,$.objectType)({name:"Block",definition(e){e.field("_id",{type:"ID"}),e.string("title"),e.string("description")}}),ie=async e=>await F(ne,e),re=(0,$.inputObjectType)({name:"createBlockInput",definition(e){e.string("title",{required:!0}),e.string("description")}}),se=(0,$.inputObjectType)({name:"editBlockInput",definition(e){e.string("id",{required:!0}),e.string("title",{required:!0}),e.string("description")}}),ne="Blocks",ae={type:[te],query:[e=>e.list.field("getAllBlocks",{type:te,nullable:!0,resolve:async(...e)=>await(async()=>{const e=await U(ne,{});if(e)return e})(...e)})],mutation:[e=>e.field("createBlock",{type:te,args:{block:(0,$.arg)({required:!0,type:re})},resolve:async(...e)=>await(async(e,{block:t})=>{try{if(t?.title.length<2)throw new Error("error.validation.titleIsTooSmall");const e=await(async e=>(console.log(ne),await L(ne,{title:e})))(t.title);if(console.log(e),e)throw new Error("contexttest.createBlock.errors.alreadyCreated");const i=await J(ne,{title:t.title,description:t.description,createdAt:new Date,updatedAt:new Date});if(i&&i._id)return i;throw new Error("contexttest.createBlock.failedToCreateBlock")}catch(e){throw new b.ForbiddenError(e)}})(...e)}),e=>e.field("editBlock",{type:te,args:{block:(0,$.arg)({required:!0,type:se})},resolve:async(...e)=>await(async(e,{block:t})=>{try{if(t?.title.length<2)throw new Error("error.validation.titleIsTooSmall");if(!await ie(t.id))throw new Error("contexttest.editBlock.errors.noBlockFound");console.log("---idblock to edit"),console.log(t);const e=await Y(ne,t.id,{$set:{title:t.title,description:t.description,updatedAt:new Date}});if(e&&e._id)return e;throw new Error("contexttest.editBlock.failedToEditBlock")}catch(e){throw new b.ForbiddenError(e)}})(...e)}),e=>e.field("deleteBlock",{type:te,args:{_id:(0,$.idArg)({required:!0})},resolve:async(...e)=>await(async(e,{_id:t})=>{const i=await ie(t);if(!i)throw new Error("contexttest.deleteBlock.errors.noBlockFound");return await W(ne,t),console.log("------blockToDelete-------"),console.log(i),i})(...e)})],input:[re,se]},oe=(0,$.objectType)({name:"PhilipsHueBridgeDetailsType",definition(e){e.string("name"),e.string("datastoreversion"),e.string("swversion"),e.string("apiversion"),e.string("mac"),e.string("bridgeid"),e.boolean("factorynew"),e.string("replacesbridgeid",{nullable:!0}),e.string("modelid"),e.string("starterkitid")}});var le=i(45933);const ce=(e,t,i)=>{const r=[];for(const s of i)if(s._id.toString()===t.toString())for(let i of e)r.push({...s?.lights?.[i],bridgeId:t,lightId:i}??{});return r},de=new(i.n(le)())((e=>(e=>{const t=[...new Set(e.map((e=>e.lightIds)))],i=e.map((e=>e.bridgeId));return(async(e,t,i)=>{const r=await U(Ce,{_id:{$in:i.map((e=>new N.ObjectId(e)))}}),s=[];for(const i in e){let n=ce(e[i],t[i],r);s.push(n||[])}return s})(t,i,[...new Set(i)])})(e)),{cache:!1}),pe=(0,$.objectType)({name:"PhilipsHueLightXY",definition(e){e.float("x",{nullable:!0}),e.float("y",{nullable:!0})}}),ue=(0,$.objectType)({name:"PhilipsHueLightState",definition(e){e.boolean("on"),e.int("bri"),e.int("hue",{nullable:!0}),e.int("sat",{nullable:!0}),e.string("effect",{nullable:!0}),e.field("xy",{type:pe,resolve:async(...e)=>ye(...e)}),e.string("alert"),e.int("ct"),e.string("colormode"),e.string("mode"),e.boolean("reachable")}}),ye=async({xy:e})=>({x:e?.[0],y:e?.[1]}),ge=(0,$.objectType)({name:"PhilipsHueLight",definition(e){e.id("bridgeId"),e.id("lightId"),e.string("name"),e.string("type"),e.string("modelid"),e.string("manufacturername"),e.string("productname"),e.string("uniqueid"),e.string("swversion"),e.string("swconfigid"),e.string("productid"),e.field("state",{type:ue})}});var he=i(9669),me=i.n(he);const we=j()((()=>L(Q,{slug:"philips_hue"}))),fe=async(e="GET",t="",i)=>{const r=await we();if(r){const s=await U(Ce,{providerId:new N.ObjectId(r._id)});let n=[];for(let r of s)n.push(new Promise((s=>{me()({method:e,url:`http://${r.ipAddress}/api/${r.token}/${t}`,data:i}).then((e=>s({...e,_id:r._id}))).catch((e=>s({...e,error:!0})))})));return Promise.allSettled(n).then((e=>e))}throw new Error("Provider not found")},be=async(e="GET",t="",i,r)=>{if(i?.ipAddress&&i?.token)try{const s=await me()({method:e,url:`http://${i.ipAddress}/api/${i.token}/${t}`,data:r});if(s.data?.[0]?.error)throw new Error(s.data[0].error.description);return s}catch(e){throw new Error(e)}throw new Error("parameters are missing")},_e=(0,$.objectType)({name:"PhilipsHueSceneLightState",definition(e){e.id("lightId"),e.id("bridgeId"),e.boolean("on"),e.int("bri"),e.int("ct",{nullable:!0}),e.field("xy",{type:pe,resolve:async(...e)=>je(...e)})}}),je=async({xy:e})=>({x:e?.[0],y:e?.[1]}),ve=(0,$.objectType)({name:"philipsHueScene",definition(e){e.id("bridgeId"),e.id("sceneId"),e.string("name"),e.string("group"),e.string("type"),e.list.field("lights",{type:ge,resolve:async(...e)=>Ie(...e)}),e.list.field("lightstates",{type:_e,resolve:async(...e)=>Ee(...e)})}}),Ie=async({lights:e,bridgeId:t})=>await de.load({lightIds:e,bridgeId:t}),Ee=async({sceneId:e,bridgeId:t})=>{const i=await F(Ce,t),r=await be("GET",`scenes/${e}`,i);return console.log("$$$$$$$$$$$$$$$$$$$$$$$$$$$"),console.log(e),console.log(Object.keys(r.data.lightstates).map((e=>({...r.data.lightstates[e],bridgeId:t,lightId:e})))),console.log("$$$$$$$$$$$$$$$$$$$$$$$$$$$"),Object.keys(r.data.lightstates).map((e=>({...r.data.lightstates[e],bridgeId:t,lightId:e})))},ke=(0,$.objectType)({name:"PhilipsHueGroupsState",definition(e){e.boolean("all_on"),e.boolean("any_on")}}),Te=(0,$.objectType)({name:"PhilipsHueGroups",definition(e){e.id("groupId"),e.id("bridgeId"),e.string("name"),e.string("type"),e.string("class",{nullable:!0}),e.boolean("recycle"),e.list.field("lights",{type:ge,resolve:async(...e)=>$e(...e)}),e.list.field("scenes",{type:ve,resolve:async(...e)=>Oe(...e)}),e.field("state",{type:ke})}}),$e=async({lights:e,bridgeId:t})=>await de.load({lightIds:e,bridgeId:t}),Oe=async({groupId:e,bridgeId:t})=>{const i=await F(Ce,t),r=Object.keys(i.scenes);let s=[];for(let n of r){const r=i.scenes[n];r.group===e&&s.push({bridgeId:t,sceneId:n,...r})}return s},Se=(0,$.objectType)({name:"PhilipsHueBridge",definition(e){e.id("_id"),e.id("providerId"),e.string("ipAddress"),e.string("token",{nullable:!0}),e.field("config",{type:oe}),e.list.field("groups",{type:Te,resolve:async(...e)=>Ae(...e)}),e.list.field("lights",{type:ge,resolve:async(...e)=>qe(...e)})}}),Ae=async({_id:e,groups:t})=>Object.keys(t).map((i=>({...t[i],bridgeId:e,groupId:i}))).filter((e=>"Room"===e.type)),qe=async({_id:e,lights:t})=>Object.keys(t).map((i=>({...t[i],bridgeId:e,lightId:i}))),Pe=(0,$.objectType)({name:"PhilipsHue",definition(e){e.field("_id",{type:"ID"}),e.string("title"),e.string("description"),e.list.field("bridges",{type:Se,resolve:async(...e)=>He(...e)})}}),He=async({_id:e})=>await U(Ce,{providerId:e}),xe=(0,$.objectType)({name:"PhilipsHueBridgeStatus",definition(e){e.boolean("ok"),e.string("error",{nullable:!0}),e.string("bridgeId",{nullable:!0})}}),De=(0,$.objectType)({name:"PhilipsHueSensor",definition(e){e.string("name"),e.string("type"),e.string("modelid"),e.string("manufacturername"),e.string("swversion"),e.string("uniqueid"),e.boolean("recycle")}}),Ne=(0,$.inputObjectType)({name:"PhilipsHueStateInput",definition(e){e.boolean("on"),e.int("bri"),e.int("hue"),e.int("sat"),e.string("scene"),e.list.float("xy")}}),Re=new(i(27111).PubSub),Be=async()=>{const e=await fe();if(e.length>0)for(let t of e)if(t?.value?.data){const{data:e,_id:i}=t.value;await G(Ce,i,{$set:{...e}})}},ze=(0,$.objectType)({name:"Response",definition(e){e.boolean("ok"),e.string("error",{nullable:!0})}}),Ce="Bridges",Me={type:[Pe,Se,xe,oe,xe,ge,ue,pe,De,ke,ve,_e],query:[e=>e.field("getPhilipsHueDevices",{type:Pe,nullable:!0,resolve:async(...e)=>await(async()=>await L(Q,{slug:"philips_hue"}))(...e)}),e=>e.field("hueBridgeConnection",{type:xe,nullable:!0,args:{ipAddress:(0,$.stringArg)({required:!0})},resolve:async(...e)=>await(async(e,{ipAddress:t})=>{const i=await(async e=>await new Promise((t=>{me()({method:"GET",url:`http://${e}/api/config/swupdate`}).then((e=>{t(e)})).catch((e=>{t({...e,error:!0})}))})))(t);return i?.data?.bridgeid?{ok:!0,bridgeId:i.data.bridgeid}:{ok:!1}})(...e)}),e=>e.field("hueBridgeRegister",{type:xe,nullable:!0,args:{ipAddress:(0,$.stringArg)({required:!0}),name:(0,$.stringArg)({required:!0})},resolve:async(...e)=>await(async(e,{ipAddress:t,name:i})=>{const r=await(async(e,t)=>await new Promise((i=>{me()({method:"POST",url:`http://${e}/api`,data:{devicetype:t}}).then((e=>{i(e)})).catch((e=>{i({...e,error:!0})}))})))(t,i);if(await L(Ce,{name:i}))throw new Error("This bridge is already added");if(r?.data?.[0]){const e=r?.data?.[0];if(console.log(e),"link button not pressed"===e?.error?.description)return{ok:!1,error:e.error.description};if(e.success){const i=await L(Q,{slug:"philips_hue"});return await J(Ce,{providerId:i._id,ipAddress:t,token:e.success.username}),{ok:!0}}throw new Error("Fail to get information from the bridge.")}throw new Error("Fail to get information from the bridge.")})(...e)}),e=>e.list.field("getScenesByGroup",{type:ve,nullable:!0,args:{groupId:(0,$.idArg)({required:!0}),bridgeId:(0,$.idArg)({required:!0})},resolve:async(...e)=>await(async(e,{bridgeId:t,groupId:i})=>{const r=await F(Ce,t);if(!r)throw new Error("Bridge not found");const s=Object.keys(r.scenes);let n=[];for(let e of s){const s=r.scenes[e];s.group===i&&n.push({bridgeId:t,sceneId:e,...s})}return n.filter((e=>"HueEssentialsEffect"!==e.name))})(...e)})],mutation:[e=>e.field("editGroupState",{type:Pe,args:{bridgeId:(0,$.idArg)({required:!0}),groupId:(0,$.idArg)({required:!0}),state:(0,$.arg)({required:!0,type:Ne})},resolve:async(...e)=>await(async(e,{bridgeId:t,groupId:i,state:r})=>{const s=await F(Ce,t);if(!s)throw new Error("bridge not found");await be("PUT",`groups/${i}/action`,s,{...r}),await Be();const n=await L(Q,{slug:"philips_hue"});return Re.publish(D.RY.SYNC_PHILIPS_HUE,{philipsHue:n}),n})(...e)}),e=>e.field("editGroupStateWhitoutSync",{type:ze,args:{bridgeId:(0,$.idArg)({required:!0}),groupId:(0,$.idArg)({required:!0}),state:(0,$.arg)({required:!0,type:Ne})},resolve:async(...e)=>await(async(e,{bridgeId:t,groupId:i,state:r})=>{const s=await F(Ce,t);if(!s)throw new Error("bridge not found");return be("PUT",`groups/${i}/action`,s,r),{ok:!0}})(...e)}),e=>e.field("editLightState",{type:Pe,args:{bridgeId:(0,$.idArg)({required:!0}),lightId:(0,$.idArg)({required:!0}),state:(0,$.arg)({required:!0,type:Ne})},resolve:async(...e)=>await(async(e,{bridgeId:t,lightId:i,state:r})=>{const s=await F(Ce,t);if(!s)throw new Error("bridge not found");console.log(r);const n=await be("PUT",`lights/${i}/state`,s,r);console.log(n.data),await Be();const a=await L(Q,{slug:"philips_hue"});return Re.publish(D.RY.SYNC_PHILIPS_HUE,{philipsHue:a}),a})(...e)}),e=>e.field("editLightStateWhitoutSync",{type:ze,args:{bridgeId:(0,$.idArg)({required:!0}),lightId:(0,$.idArg)({required:!0}),state:(0,$.arg)({required:!0,type:Ne})},resolve:async(...e)=>await(async(e,{bridgeId:t,lightId:i,state:r})=>{const s=await F(Ce,t);if(!s)throw new Error("bridge not found");return be("PUT",`lights/${i}/state`,s,r),{ok:!0}})(...e)})],input:[Ne]},Ue=(0,$.objectType)({name:"SyncAll",definition(e){e.field("philipsHue",{type:Pe,resolve:async(...e)=>Le(...e)})}}),Le=async({philipsHue:e})=>e??await L(Q,{slug:"philips_hue"});var Fe=i(63403);const Ge=(0,$.subscriptionField)("syncAll",{type:Ue,subscribe:(0,Fe.withFilter)((()=>Re.asyncIterator(D.RY.SYNC_PHILIPS_HUE)),(async()=>!0)),resolve:e=>e}),Ye={type:[Ue],query:[e=>e.field("syncAll",{type:Ue,nullable:!0,resolve:async(...e)=>await(async()=>({philipsHue:await L(Q,{slug:"philips_hue"})}))(...e)})],subscription:[Ge]},Je=async(e,t)=>{const{RAPID_API_WEATHER_HOST:i,RAPID_API_KEY:r}=process.env;return await me().get("https://community-open-weather-map.p.rapidapi.com/weather",{headers:{"x-rapidapi-key":r,"x-rapidapi-host":i,useQueryString:!0},params:{q:`${t},${e}`,units:"metric"}}).then((e=>e)).catch((e=>e))},We=(0,$.objectType)({name:"Weather",definition(e){e.field("_id",{type:"ID"}),e.string("city"),e.string("country"),e.float("visibility"),e.float("dt"),e.float("clouds",{resolve:async(...e)=>Ke(...e)}),e.float("wind",{resolve:async(...e)=>Qe(...e)}),e.float("humidity",{resolve:async(...e)=>Ze(...e)}),e.float("temp",{resolve:async(...e)=>Ve(...e)}),e.float("feels_like",{resolve:async(...e)=>Xe(...e)}),e.float("temp_min",{resolve:async(...e)=>et(...e)}),e.float("temp_max",{resolve:async(...e)=>tt(...e)}),e.float("pressure",{resolve:async(...e)=>it(...e)}),e.string("main",{resolve:async(...e)=>rt(...e)}),e.string("description",{resolve:async(...e)=>st(...e)}),e.string("icon",{resolve:async(...e)=>nt(...e)})}}),Ze=async({humidity:e,main:t})=>e||t.humidity,Ke=async({clouds:e})=>"string"==typeof e?e:e.all,Qe=async({wind:e})=>"string"==typeof e?e:e.speed,Ve=async({temp:e,main:t})=>e||t.temp,Xe=async({feels_like:e,main:t})=>e||t.feels_like,et=async({temp_min:e,main:t})=>e||t.temp_min,tt=async({temp_max:e,main:t})=>e||t.temp_max,it=async({pressure:e,main:t})=>e||t.pressure,rt=async({main:e,weather:t})=>"string"==typeof e?e:t?.[0]?.main,st=async({description:e,weather:t})=>e||t?.[0]?.description,nt=async({icon:e,weather:t})=>e||t?.[0]?.icon,at=(0,$.subscriptionField)("syncWeather",{type:We,subscribe:(0,Fe.withFilter)((()=>Re.asyncIterator(D.RY.SYNC_WHEATER)),(async()=>!0)),resolve:e=>e}),ot="Weather",lt=[q,H,ae,Ye,V,Me,{type:[We],query:[e=>e.field("getWeatherInfo",{type:We,nullable:!0,resolve:async(...e)=>await(async()=>{const e=await U(ot,{});return e?.[0]?._id?e[0]:null})(...e)})],mutation:[e=>e.field("updateWeatherLocation",{type:We,args:{city:(0,$.stringArg)({required:!0}),country:(0,$.stringArg)({required:!0})},resolve:async(...e)=>await(async(e,{city:t,country:i})=>{const r=await U(ot,{}),s=await Je(i,t);if(console.log(s),200!==s.status)throw new Error("City not found");let n=null;return n=r?.[0]?._id?await Y(ot,r[0]._id,{$set:{city:t,country:i,...s.data}}):await J(ot,{city:t,country:i,...s.data}),n})(...e)})],subscription:[at]},ee];var ct=i(13808);const{GRAPHQL_QUERY_MAX_DEPTH:dt,ACCESS_TOKEN:pt}=process.env,ut=(e,{context:t})=>(t.memoizer.clear(),e),yt=e=>(console.log("_________________________________"),console.log(e),console.log("_________________________________"),e),gt=(0,$.makeSchema)({types:[(ht=lt,(0,$.queryType)({definition(e){ht.forEach((t=>{t.query&&t.query.forEach((t=>{t(e)}))}))}})),(e=>e.map((e=>e.type)))(lt),(e=>(0,$.mutationType)({definition(t){e.forEach((e=>{e.mutation&&e.mutation.forEach((e=>{e(t)}))}))}}))(lt),(e=>e.map((e=>e.subscription)))(lt),(e=>e.map((e=>e.scalar)))(lt),(e=>e.map((e=>e.input)))(lt),(e=>e.map((e=>e.enum)))(lt),(e=>e.map((e=>e.union)))(lt)],outputs:{schema:f().join(__dirname.replace(/\/dist$/,"/bin"),"../../bin/portal_api_schema.graphql"),typegen:f().join(__dirname.replace(/\/dist$/,"/bin"),"../../bin/portal_api_schema_typegen.ts")}});var ht;const{REDIS_PORT:mt,REDIS_HOST:wt}=process.env;var ft=i(54005),bt=i.n(ft);const{REDIS_HOST:_t,REDIS_PORT:jt}=process.env;var vt=i(41976);var It=i(95692);const Et=d()(),kt=s()(),Tt=a().createServer(kt),{DOMOTICZ_HOST:$t,DOMOTICZ_PORT:Ot,NODE_ENV:St}=process.env;kt.use(g()({origin:"*",credentials:!0})),kt.use(l().text({type:"application/graphql"})),[{path:"/health",type:"get",controller:async(e,t)=>{try{return t.status(200).send("Health check success")}catch(e){return t.status(400).send(e.message)}}}].forEach((({type:e,path:t,controller:i})=>{kt[e](t,((e,t)=>{i(e,t)}))})),Et.start("Starting portal-api server...");const At=async()=>{try{const e=((e=!0)=>new b.ApolloServer({schema:gt,validationRules:[m()(dt)],playground:e,introspection:!0,tracing:!0,formatError:yt,formatResponse:ut,context:e=>(async e=>{let t,i;const r=e.req&&e.req.headers,s=e.connection&&e.connection.context;if(r){const e=r[pt];e&&(t=e.replace("Bearer ",""),i=await T(t))}if(s&&s&&s.headers.context){const e=s.headers.context,r=e.token||e[pt];r&&(t=r.replace("Bearer ",""),i=await T(t))}return{headers:r,memoizer:new v,token:t,identityEmail:i?.identity_email,currentUser:i}})(e),subscriptions:{onConnect:async e=>{if(e?.headers?.context){const t=e.headers.context;if(t.token||t[pt])return e}throw new Error("Missing auth token!")}},persistedQueries:{cache:new ct.ES({port:mt,host:wt}),ttl:900}}))("development"===St&&!0);e.installSubscriptionHandlers(Tt),e.applyMiddleware({app:kt,path:"/"}),"true"!==process.env.INTERNAL&&("true"===process.env.INTERNAL?null:new(bt())(jt,_t)).publish("updateServer","Restart Portal API"),Tt.listen(Ot,(()=>{Et.succeed(),console.log(u().green("✓"),`Server ready. -> start on ${$t}:${Ot}/`)}))}catch(e){Et.fail(),await(0,It.Dc)(5e3),console.log("💣",e.message),console.log("💣","reconnecting in 5 seconds"),At()}};At(),new vt.CronJob("*/3 * * * * *",(async()=>{const e=await fe();if(e.length>0)for(let t of e)if(t?.value?.data){const{data:e,_id:i}=t.value;await G(Ce,i,{$set:{...e}});const r=await L(Q,{slug:"philips_hue"});Re.publish(D.RY.SYNC_PHILIPS_HUE,{philipsHue:r})}}),null,!0,"Europe/Brussels").start(),(async()=>{new vt.CronJob("*/15 * * * *",(async()=>{const e=await U(ot,{});if(e?.[0]?._id){const t=await Je(e[0].country,e[0].city);200===t.status&&await Y(ot,e[0]._id,{$set:{...t.data}});const i=await F(ot,e[0]._id);Re.publish(D.RY.SYNC_WHEATER,i)}}),null,!0,"Europe/Brussels").start()})(),Tt.on("error",(e=>{Et.fail(),console.log(e),console.log("💣",u().red("error:"),e.message)}))}};